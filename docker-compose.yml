services:
  dcfw:
    image: dimajix/dcfw
    build:
      context: .
    read_only: true
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - CAP_NET_ADMIN
      - CAP_NET_BIND_SERVICE
      - CAP_SYS_ADMIN
      - CAP_KILL
      - CAP_CHOWN
      - CAP_SETGID
      - CAP_SETUID
      - CAP_DAC_OVERRIDE
    command:
      - --proc-dir=/host/proc
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc:/host/proc
      - type: tmpfs
        target: /var/run

  http-bridge:
    image: httpd:2.2-alpine
    read_only: true
    cap_drop:
      - ALL
    cap_add:
      - CAP_CHOWN
      - CAP_SETGID
      - CAP_SETUID
      - CAP_KILL
    labels:
      - dcfw.enable=true
      - dcfw.input.policy=deny
      - dcfw.input.rule.1=allow log on eth0 proto tcp from 192.168.110.0/24 to any port 80
      - dcfw.input.rule.2=allow log on eth0 proto tcp from 172.16.64.0/24 to any port 80
      - dcfw.output.policy=deny
      #- dcfw.output.rule.1=allow proto tcp to 192.168.150.6 port 8080
      #- dcfw.output.rule.2=deny on eth0 to 0.0.0.0/0
    networks:
      firewall-bridge:
        ipv4_address: 172.16.64.6

  shell-bridge:
    image: ubuntu:24.04
    #cap_drop:
    #  - ALL
    cap_add:
      - CAP_CHOWN
      - CAP_SETGID
      - CAP_SETUID
      - CAP_DAC_OVERRIDE
      - CAP_KILL
    labels:
      - dcfw.enable=true
      - dcfw.input.policy=deny
      - dcfw.output.policy=deny
      - dcfw.output.rule.1=allow log proto tcp to 192.168.150.6 port 8080 comment "Allow communication to proxy"
      - dcfw.output.rule.3=allow log proto tcp to 172.16.64.6 port 80 comment "Allow communication to web server"
    networks:
      firewall-bridge:
        ipv4_address: 172.16.64.7

  http-macvlan:
    image: httpd:2.2-alpine
    read_only: true
    cap_drop:
      - ALL
    cap_add:
      - CAP_CHOWN
      - CAP_SETGID
      - CAP_SETUID
      - CAP_KILL
    labels:
      dcfw.enable: true
      dcfw.input.policy: deny
      dcfw.input.rule.1: allow log on eth0 proto tcp from 192.168.110.0/24 to any port 80
      dcfw.output.policy: deny
      dcfw.output.rule.1: allow log proto tcp to 192.168.150.6 port 8080
      dcfw.output.rule.2: allow log proto tcp to 192.168.110.1 port 53
      #dcfw.output.rule.1: allow proto tcp to 192.168.150.6 port 8080
      #dcfw.output.rule.2: deny on eth0 to 0.0.0.0/0
    networks:
      firewall-macvlan:
        ipv4_address: 192.168.110.2

networks:
  firewall-bridge:
    driver: bridge
  firewall-macvlan:
    driver: macvlan
    driver_opts:
      parent: enp89s0
    ipam:
      config:
        - subnet: 192.168.110.0/24
          ip_range: 192.168.110.0/24
          gateway: 192.168.110.1
